// Chatbot functionality for Learning App
// Education-focused chatbot with learning-related responses

// Chatbot state
let chatbotOpen = false;
let chatHistory = [];
let chatSessionId = null; // Unique session ID for this conversation

// Initialize chatbot
function initChatbot() {
    const chatButton = document.getElementById('chatbot-button');
    const chatWindow = document.getElementById('chatbot-window');
    const chatClose = document.getElementById('chatbot-close');
    const chatInput = document.getElementById('chatbot-input');
    const chatSend = document.getElementById('chatbot-send');
    const chatMessages = document.getElementById('chatbot-messages');

    // Open/close chatbot - prevent event bubbling
    if (chatButton) {
        chatButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleChatbot(e);
        });
    }

    if (chatClose) {
        chatClose.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleChatbot(e);
        });
    }

    // Prevent clicks inside chat window from closing it
    if (chatWindow) {
        chatWindow.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }

    // Send message on button click
    if (chatSend) {
        chatSend.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            sendMessage();
        });
    }

    // Send message on Enter key
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                e.stopPropagation();
                sendMessage();
            }
        });
    }
}

// Toggle chatbot window
function toggleChatbot(e) {
    // Prevent any event propagation
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    // Toggle state
    chatbotOpen = !chatbotOpen;
    const chatWindow = document.getElementById('chatbot-window');
    const chatButton = document.getElementById('chatbot-button');
    const chatMessages = document.getElementById('chatbot-messages');

    if (chatWindow) {
        if (chatbotOpen) {
            chatWindow.style.display = 'flex';
            chatWindow.style.animation = 'slideUp 0.3s ease-out';
            
            // Create new session ID if this is a new conversation
            if (!chatSessionId || (chatMessages && chatMessages.children.length === 0)) {
                chatSessionId = generateSessionId();
                chatHistory = []; // Reset history for new session
                console.log('New chat session created:', chatSessionId);
            }
            
            // Don't add hardcoded welcome message - let LLM generate it naturally
            // Welcome message will be generated when user sends first message
            
            // Focus input when opened
            setTimeout(() => {
                const chatInput = document.getElementById('chatbot-input');
                if (chatInput) chatInput.focus();
            }, 300);
        } else {
            chatWindow.style.animation = 'slideDown 0.3s ease-out';
            setTimeout(() => {
                if (!chatbotOpen) { // Double check state before hiding
                    chatWindow.style.display = 'none';
                }
            }, 300);
        }
    }

    if (chatButton) {
        chatButton.classList.toggle('active', chatbotOpen);
    }
}

// Add welcome message - This will be generated by the LLM, not hardcoded
function addWelcomeMessage() {
    // Don't add hardcoded message - let the LLM generate it when user sends first message
    // This ensures all responses come from the LLM
}

// Send user message
async function sendMessage() {
    const chatInput = document.getElementById('chatbot-input');
    const chatSend = document.getElementById('chatbot-send');
    const message = chatInput ? chatInput.value.trim() : '';

    if (!message) return;

    // Add user message to chat
    addMessage('user', message);

    // Clear input and disable send button
    if (chatInput) {
        chatInput.value = '';
        chatInput.disabled = true;
    }
    if (chatSend) {
        chatSend.disabled = true;
        chatSend.innerHTML = '<span>‚è≥</span>';
    }

    // Add thinking indicator
    const thinkingId = addThinkingIndicator();

    try {
        // Prepare conversation history for context
        const history = chatHistory.slice(-10).map(msg => ({
            user: msg.sender === 'user' ? msg.text : '',
            assistant: msg.sender === 'bot' ? msg.text : ''
        })).filter(msg => msg.user || msg.assistant);

        // Call LLM API with session ID
        const response = await fetch('/api/chatbot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                session_id: chatSessionId,
                history: history
            })
        });

        // Remove thinking indicator
        removeThinkingIndicator(thinkingId);

        const data = await response.json();

        if (data.success) {
            // Update session ID if returned from server
            if (data.session_id && data.session_id !== chatSessionId) {
                chatSessionId = data.session_id;
                console.log('Session ID updated from server:', chatSessionId);
            }
            addMessage('bot', data.response);
        } else {
            addMessage('bot', data.response || data.error || "I'm sorry, I encountered an error. Please try again.");
        }
    } catch (error) {
        console.error('Chatbot error:', error);
        removeThinkingIndicator(thinkingId);
        addMessage('bot', "I'm sorry, I'm having trouble connecting. Please check your internet connection and try again.");
    } finally {
        // Re-enable input and send button
        if (chatInput) {
            chatInput.disabled = false;
            setTimeout(() => chatInput.focus(), 100);
        }
        if (chatSend) {
            chatSend.disabled = false;
            chatSend.innerHTML = '<span>‚û§</span>';
        }
    }
}

// Add thinking indicator while waiting for LLM response
function addThinkingIndicator() {
    const chatMessages = document.getElementById('chatbot-messages');
    if (!chatMessages) return null;

    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'chat-message bot thinking';
    thinkingDiv.id = 'thinking-indicator';
    
    const thinkingContent = document.createElement('div');
    thinkingContent.className = 'message-content';
    thinkingContent.innerHTML = '<span class="thinking-dots">ü§î Thinking</span>';
    
    thinkingDiv.appendChild(thinkingContent);
    chatMessages.appendChild(thinkingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    return 'thinking-indicator';
}

// Remove thinking indicator
function removeThinkingIndicator(thinkingId) {
    if (!thinkingId) return;
    const thinkingDiv = document.getElementById(thinkingId);
    if (thinkingDiv) {
        thinkingDiv.remove();
    }
}

// Add message to chat
function addMessage(sender, text) {
    const chatMessages = document.getElementById('chatbot-messages');
    if (!chatMessages) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}`;

    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    
    // Render markdown if marked.js is available, otherwise fallback to plain text
    if (typeof marked !== 'undefined') {
        // Configure marked.js options
        marked.setOptions({
            breaks: true,  // Convert single line breaks to <br>
            gfm: true,    // GitHub Flavored Markdown (includes tables)
            tables: true, // Enable tables (redundant with gfm, but explicit)
            headerIds: true, // Enable header IDs
            mangle: false, // Don't mangle email addresses
            pedantic: false, // Don't be pedantic about markdown
            sanitize: false, // Allow HTML (we'll sanitize manually if needed)
            smartLists: true, // Use smart list behavior
            smartypants: false // Don't use smart typography
        });
        
        try {
            // Render markdown to HTML
            messageContent.innerHTML = marked.parse(text);
        } catch (error) {
            console.error('Markdown parsing error:', error);
            // Fallback to plain text with line breaks
            const escapedText = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
            messageContent.innerHTML = escapedText.replace(/\n/g, '<br>');
        }
    } else {
        // Fallback if marked.js is not loaded
        const escapedText = text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        messageContent.innerHTML = escapedText.replace(/\n/g, '<br>');
    }

    messageDiv.appendChild(messageContent);
    chatMessages.appendChild(messageDiv);

    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Add to history
    chatHistory.push({ sender, text, timestamp: new Date() });
}

// Generate unique session ID
function generateSessionId() {
    // Generate a unique session ID using timestamp and random string
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 15);
    return `chat_${timestamp}_${random}`;
}

// Make functions globally accessible
window.initChatbot = initChatbot;
window.toggleChatbot = toggleChatbot;
window.sendMessage = sendMessage;
window.generateSessionId = generateSessionId;

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    initChatbot();
});

