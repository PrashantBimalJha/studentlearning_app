{% extends "base.html" %}

{% block title %}Learn with Games - Crossword{% endblock %}

{% block content %}
<div class="learn-page">
    <div class="page-header">
        <div class="header-content">
            <h1>üß© Learn with Games</h1>
            <p>Solve subject-wise crossword style puzzles generated by the AI tutor.</p>
        </div>
    </div>

    <div class="games-grid">
        <div class="game-card">
            <div class="game-header">
                <div class="game-icon">‚úèÔ∏è</div>
                <div>
                    <h2>Crossword Puzzle</h2>
                    <p>Fill the boxes using clues. All words are related to your chosen subject.</p>
            </div>
        </div>
        
            <div class="game-controls">
                <div class="form-row">
                    <div class="form-group">
                        <label for="cw-subject">Subject</label>
                        <select id="cw-subject">
                            <option value="Mathematics">Mathematics</option>
                            <option value="Science">Science</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                            <option value="English">English</option>
                            <option value="History">History</option>
                            <option value="Geography">Geography</option>
                            <option value="Computer Science">Computer Science</option>
                </select>
            </div>
                    <div class="form-group">
                        <label for="cw-level">Level</label>
                        <select id="cw-level">
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                </select>
            </div>
                </div>
                <button class="btn-primary" id="cw-generate-btn" onclick="startCrosswordGame()">
                    Generate Crossword
                </button>
            </div>

            <div class="game-body">
                <div class="game-timer-row">
                    <span id="cw-timer" class="game-timer">Time: 0s</span>
                </div>
                <div id="crosswordArea">
                    <p class="game-hint">
                        Choose a subject and level, then click "Generate Crossword" to get new clues and words.
                    </p>
                </div>
            </div>
    </div>

        <div class="game-card">
            <div class="game-header">
                <div class="game-icon">üîé</div>
                <div>
                    <h2>Word Search</h2>
                    <p>Find hidden subject words inside the letter grid.</p>
        </div>
    </div>

            <div class="game-controls">
                <div class="form-row">
                    <div class="form-group">
                        <label for="ws-subject">Subject</label>
                        <select id="ws-subject">
                            <option value="Mathematics">Mathematics</option>
                            <option value="Science">Science</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                            <option value="English">English</option>
                            <option value="History">History</option>
                            <option value="Geography">Geography</option>
                            <option value="Computer Science">Computer Science</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ws-level">Level</label>
                        <select id="ws-level">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                </div>
                <button class="btn-primary" id="ws-generate-btn" onclick="startWordSearchGame()">
                    Generate Word Search
                </button>
            </div>

            <div class="game-body">
                <div class="game-timer-row">
                    <span id="ws-timer" class="game-timer">Time: 0s</span>
                </div>
                <div id="wordSearchArea">
                    <p class="game-hint">
                        Choose a subject and level, then click "Generate Word Search". Try to spot all the hidden words!
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.games-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
    margin-top: 20px;
}

.game-card {
    background: white;
    border-radius: 18px;
    padding: 20px 22px;
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.08);
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.game-header {
    display: flex;
    gap: 14px;
    align-items: center;
}

.game-icon {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.6rem;
    background: linear-gradient(135deg, #4f46e5, #6366f1);
    color: #fff;
}

.game-header h2 {
    margin: 0 0 4px 0;
}

.game-header p {
    margin: 0;
    color: #6b7280;
    font-size: 0.95rem;
}

.game-controls {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.game-body {
    background: #f9fafb;
    border-radius: 14px;
    padding: 14px 16px;
    min-height: 160px;
}

.game-hint {
    margin: 0;
    color: #6b7280;
    font-size: 0.95rem;
}

.form-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.form-group {
    flex: 1;
    min-width: 140px;
}

.form-group label {
    display: block;
    margin-bottom: 4px;
    font-size: 0.85rem;
    color: #4b5563;
}

.form-group select {
    width: 100%;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid #d1d5db;
}

.cw-wrapper {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    gap: 16px;
}

.cw-grid {
    background: white;
    border-radius: 12px;
    padding: 10px;
    box-shadow: 0 8px 24px rgba(15,23,42,0.06);
}

.cw-clues {
    font-size: 0.95rem;
}

.cw-section-title {
    font-weight: 600;
    margin-bottom: 6px;
}

.cw-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
}

.cw-number {
    width: 20px;
    font-weight: 600;
}

.cw-cells {
    display: flex;
    gap: 4px;
}

.cw-cell {
    width: 22px;
    height: 22px;
    border-radius: 4px;
    border: 1px solid #d1d5db;
    background: #f3f4f6;
    text-transform: uppercase;
    text-align: center;
    font-size: 0.85rem;
}

.cw-cell.correct {
    background: #dcfce7;
    border-color: #16a34a;
}

.cw-cell.incorrect {
    background: #fee2e2;
    border-color: #dc2626;
}

.cw-clue-list {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.cw-clue-list li {
    margin-bottom: 4px;
}

/* Timer row */
.game-timer-row {
    display: flex;
    justify-content: flex-end;
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 4px;
}

.game-timer {
    padding: 2px 8px;
    border-radius: 999px;
    background: #e5e7eb;
}

/* Word search styles */
.ws-wrapper {
    display: grid;
    grid-template-columns: auto 220px;
    gap: 16px;
}

.ws-grid {
    display: grid;
    grid-template-columns: repeat(10, 24px);
    gap: 4px;
    padding: 10px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(15,23,42,0.06);
}

.ws-cell {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    background: #f3f4f6;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
}

.ws-cell.highlight {
    background: #c7d2fe;
    color: #1e3a8a;
}

.ws-cell.temp-select {
    background: #e0f2fe;
    border-color: #3b82f6;
}

.ws-word-list {
    font-size: 0.95rem;
}
</style>

<script>
let crosswordEntries = [];
let wordSearchWords = [];
let wordSearchGrid = [];
let wordSearchPlacements = [];
let wordSearchFound = new Set();
let wsSelectStart = null;
let cwStartTime = null;
let wsStartTime = null;
let cwTimerId = null;
let wsTimerId = null;

function startCwTimer() {
    const el = document.getElementById('cw-timer');
    if (!el) return;
    if (cwTimerId) clearInterval(cwTimerId);
    cwTimerId = setInterval(() => {
        if (!cwStartTime) return;
        const sec = Math.max(0, Math.round((Date.now() - cwStartTime) / 1000));
        el.textContent = 'Time: ' + sec + 's';
    }, 1000);
}

function stopCwTimer() {
    if (cwTimerId) {
        clearInterval(cwTimerId);
        cwTimerId = null;
    }
}

function startWsTimer() {
    const el = document.getElementById('ws-timer');
    if (!el) return;
    if (wsTimerId) clearInterval(wsTimerId);
    wsTimerId = setInterval(() => {
        if (!wsStartTime) return;
        const sec = Math.max(0, Math.round((Date.now() - wsStartTime) / 1000));
        el.textContent = 'Time: ' + sec + 's';
    }, 1000);
}

function stopWsTimer() {
    if (wsTimerId) {
        clearInterval(wsTimerId);
        wsTimerId = null;
    }
}

function renderCrossword() {
    const area = document.getElementById('crosswordArea');
    if (!crosswordEntries.length) {
        area.innerHTML = '<p class="game-hint">No crossword yet. Choose a subject and click "Generate Crossword".</p>';
        return;
    }

    // First 3 entries are Across (with boxes on the left), remaining entries are Down clues only.
    const across = crosswordEntries.slice(0, 3);
    const down = crosswordEntries.slice(3);

    let html = '<div class="cw-wrapper">';

    // Grid with inputs
    html += '<div class="cw-grid">';
    across.forEach((entry, idx) => {
        const num = idx + 1;
        const letters = entry.answer.length;
        html += '<div class="cw-row">';
        html += `<div class="cw-number">${num}</div>`;
        html += `<div class="cw-cells" data-word="${num}" data-idx="${idx}">`;
        for (let i = 0; i < letters; i++) {
            html += `<input maxlength="1" class="cw-cell" data-word="${num}" data-pos="${i}" />`;
        }
        html += '</div>';
        html += '</div>';
    });
    html += '<div style="margin-top:10px; font-size:0.85rem; color:#6b7280;">Type letters in the boxes, then click "Check Answers" or use a hint.</div>';
    html += '</div>'; // end grid

    // Clues
    html += '<div class="cw-clues">';
    html += '<div>';
    html += '<div class="cw-section-title">Across</div>';
    html += '<ul class="cw-clue-list">';
    across.forEach((entry, idx) => {
        const num = idx + 1;
        html += `<li><strong>${num}.</strong> ${entry.clue}</li>`;
    });
    html += '</ul>';
    html += '</div>';

    if (down.length) {
        html += '<div style="margin-top:10px;">';
        html += '<div class="cw-section-title">Down</div>';
        html += '<ul class="cw-clue-list">';
        down.forEach((entry, idx) => {
            const num = across.length + idx + 1;
            html += `<li><strong>${num}.</strong> ${entry.clue}</li>`;
        });
        html += '</ul>';
        html += '</div>';
    }

    html += '<div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">';
    html += '<button type="button" class="btn-primary" onclick="checkCrosswordAnswers()">Complete &amp; Check</button>';
    html += '<button type="button" class="btn-secondary" onclick="giveCrosswordHint()">Hint</button>';
    html += '</div>';

    html += '</div>'; // end clues
    html += '</div>'; // end wrapper

    area.innerHTML = html;

    // Force uppercase as user types
    const inputs = area.querySelectorAll('.cw-cell');
    inputs.forEach(inp => {
        inp.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    });
}

function startCrosswordGame() {
    const subject = document.getElementById('cw-subject').value;
    const level = document.getElementById('cw-level').value;
    const btn = document.getElementById('cw-generate-btn');
    const area = document.getElementById('crosswordArea');

    btn.disabled = true;
    btn.textContent = 'Generating...';
    area.innerHTML = '<p class="game-hint">Generating crossword for ' + subject + ' (' + level + ')...</p>';

    fetch('/api/games/crossword', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ subject: subject, level: level })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success && data.entries && data.entries.length) {
            // Use at most 6 entries to keep layout simple: 3 across, 3 down
            crosswordEntries = data.entries.slice(0, 6);
            cwStartTime = Date.now();
            const timerEl = document.getElementById('cw-timer');
            if (timerEl) timerEl.textContent = 'Time: 0s';
            startCwTimer();
            renderCrossword();
        } else {
            area.innerHTML = '<p class="game-hint">Could not generate crossword. ' + (data.error || '') + '</p>';
        }
    })
    .catch(err => {
        console.error('Crossword game error', err);
        area.innerHTML = '<p class="game-hint">Something went wrong while generating crossword.</p>';
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Generate Crossword';
    });
}

function checkCrosswordAnswers() {
    if (!crosswordEntries.length) return;
    const area = document.getElementById('crosswordArea');
    const totalWords = crosswordEntries.length;
    let correctWords = 0;

    const across = crosswordEntries.slice(0, 3);

    across.forEach((entry, idx) => {
        const num = idx + 1;
        const cells = area.querySelectorAll('.cw-cell[data-word="' + num + '"]');
        let guess = '';
        cells.forEach(cell => {
            guess += (cell.value || ' ').toUpperCase();
        });

        const answer = entry.answer.toUpperCase();
        let allCorrect = true;
        cells.forEach((cell, posIdx) => {
            const expected = answer[posIdx] || '';
            if (cell.value.toUpperCase() === expected) {
                cell.classList.remove('incorrect');
                cell.classList.add('correct');
            } else {
                cell.classList.remove('correct');
                cell.classList.add('incorrect');
                allCorrect = false;
            }
        });

        if (allCorrect) {
            correctWords += 1;
        }
    });

    const elapsedSec = cwStartTime ? Math.max(1, Math.round((Date.now() - cwStartTime) / 1000)) : 0;
    stopCwTimer();
    const msg = `You solved ${correctWords} out of ${totalWords} words correctly in ${elapsedSec} seconds!`;
    alert(msg);

    // Send score (with time) to backend for leaderboard
    fetch('/api/games/crossword/score', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correct: correctWords, total: totalWords, seconds: elapsedSec })
    }).catch(err => console.error('Error sending crossword score:', err));
}

function giveCrosswordHint() {
    if (!crosswordEntries.length) return;
    const area = document.getElementById('crosswordArea');
    const across = crosswordEntries.slice(0, 3);

    // Find first word that is not fully correct and has cells
    for (let idx = 0; idx < across.length; idx++) {
        const num = idx + 1;
        const entry = across[idx];
        const cells = area.querySelectorAll('.cw-cell[data-word="' + num + '"]');
        if (!cells.length) continue;

        const answer = entry.answer.toUpperCase();
        // Collect positions that are incorrect or empty
        const candidatePositions = [];
        cells.forEach((cell, posIdx) => {
            const expected = answer[posIdx] || '';
            if (cell.value.toUpperCase() !== expected) {
                candidatePositions.push(posIdx);
            }
        });

        if (!candidatePositions.length) {
            continue; // this word already fully correct, move to next
        }

        // Pick a random position to reveal
        const pos = candidatePositions[Math.floor(Math.random() * candidatePositions.length)];
        const targetCell = cells[pos];
        if (targetCell) {
            targetCell.value = answer[pos];
            targetCell.classList.remove('incorrect');
            targetCell.classList.add('correct');
        }

        alert('Hint: we have filled one correct letter for word ' + num + '.');
        break;
    }
}

// -------- Word Search Game --------

function buildWordSearchGrid(words, size = 10) {
    // Initialize empty grid
    const grid = Array.from({ length: size }, () => Array(size).fill(null));
    const placements = [];

    const dirs = [
        { dx: 1, dy: 0 },   // right
        { dx: -1, dy: 0 },  // left
        { dx: 0, dy: 1 },   // down
        { dx: 0, dy: -1 },  // up
        { dx: 1, dy: 1 },   // diag down-right
        { dx: -1, dy: 1 },  // diag down-left
    ];

    function tryPlace(word) {
        const len = word.length;
        for (let attempt = 0; attempt < 100; attempt++) {
            const dir = dirs[Math.floor(Math.random() * dirs.length)];
            const maxX = dir.dx === 1 ? size - len : dir.dx === -1 ? size - 1 : size - 1;
            const minX = dir.dx === -1 ? len - 1 : 0;
            const maxY = dir.dy === 1 ? size - len : dir.dy === -1 ? size - 1 : size - 1;
            const minY = dir.dy === -1 ? len - 1 : 0;

            const startX = Math.floor(Math.random() * (maxX - minX + 1)) + minX;
            const startY = Math.floor(Math.random() * (maxY - minY + 1)) + minY;

            let ok = true;
            const coords = [];
            for (let i = 0; i < len; i++) {
                const x = startX + dir.dx * i;
                const y = startY + dir.dy * i;
                const existing = grid[y][x];
                if (existing && existing !== word[i]) {
                    ok = false;
                    break;
                }
                coords.push({ x, y });
            }
            if (!ok) continue;

            coords.forEach((c, i) => {
                grid[c.y][c.x] = word[i];
            });
            placements.push({ word, coords });
            return true;
        }
        return false;
    }

    words.forEach(w => {
        tryPlace(w);
    });

    // Fill remaining cells with random letters
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
            if (!grid[y][x]) {
                grid[y][x] = letters[Math.floor(Math.random() * letters.length)];
            }
        }
    }

    wordSearchGrid = grid;
    wordSearchPlacements = placements;
}

function renderWordSearch() {
    const area = document.getElementById('wordSearchArea');
    if (!wordSearchGrid.length || !wordSearchWords.length) {
        area.innerHTML = '<p class="game-hint">No word search yet. Generate one first.</p>';
        return;
    }

    let html = '<div class="ws-wrapper">';

    // Grid
    html += '<div class="ws-grid">';
    wordSearchGrid.forEach((row, y) => {
        row.forEach((ch, x) => {
            html += `<div class="ws-cell" data-x="${x}" data-y="${y}">${ch}</div>`;
        });
    });
    html += '</div>';

    // Word list and controls
    html += '<div class="ws-word-list">';
    html += '<div class="cw-section-title">Find these words</div>';
    html += '<ul class="cw-clue-list">';
    wordSearchWords.forEach(w => {
        html += `<li data-ws-word="${w}">${w}</li>`;
    });
    html += '</ul>';
    html += '<div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">';
    html += '<button type="button" class="btn-primary" onclick="completeWordSearch()">Complete</button>';
    html += '<button type="button" class="btn-secondary" onclick="showWordSearchAnswers()">Show Answers</button>';
    html += '</div>';
    html += '</div>';

    html += '</div>'; // end wrapper

    area.innerHTML = html;

    // Attach click handlers for selecting words with the mouse
    const cells = area.querySelectorAll('.ws-cell');
    cells.forEach(cell => {
        cell.addEventListener('click', handleWordSearchCellClick);
    });
}

function startWordSearchGame() {
    const subject = document.getElementById('ws-subject').value;
    const level = document.getElementById('ws-level').value;
    const btn = document.getElementById('ws-generate-btn');
    const area = document.getElementById('wordSearchArea');

    btn.disabled = true;
    btn.textContent = 'Generating...';
    area.innerHTML = '<p class="game-hint">Generating word search for ' + subject + ' (' + level + ')...</p>';

    fetch('/api/games/wordsearch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ subject: subject, level: level })
    })
    .then(res => res.json())
        .then(data => {
        if (data.success && data.words && data.words.length) {
            wordSearchWords = data.words;
            wordSearchFound = new Set();
            wsStartTime = Date.now();
            const timerEl = document.getElementById('ws-timer');
            if (timerEl) timerEl.textContent = 'Time: 0s';
            startWsTimer();
            buildWordSearchGrid(wordSearchWords, 10);
            renderWordSearch();
        } else {
            area.innerHTML = '<p class="game-hint">Could not generate word search. ' + (data.error || '') + '</p>';
        }
    })
    .catch(err => {
        console.error('Word search game error', err);
        area.innerHTML = '<p class="game-hint">Something went wrong while generating word search.</p>';
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Generate Word Search';
    });
}

function showWordSearchAnswers() {
    const area = document.getElementById('wordSearchArea');
    if (!area) return;
    const cells = area.querySelectorAll('.ws-cell');

    // Clear previous highlights
    cells.forEach(c => {
        c.classList.remove('highlight');
        c.classList.remove('temp-select');
    });

    wordSearchPlacements.forEach(p => {
        p.coords.forEach(c => {
            const cell = area.querySelector(`.ws-cell[data-x="${c.x}"][data-y="${c.y}"]`);
            if (cell) {
                cell.classList.add('highlight');
            }
        });
        // Mark word as found in list (visual only)
        const li = area.querySelector(`.ws-word-list li[data-ws-word="${p.word}"]`);
        if (li) {
            li.style.textDecoration = 'line-through';
        }
    });
}

function clearTempWsSelection() {
    const area = document.getElementById('wordSearchArea');
    if (!area) return;
    const cells = area.querySelectorAll('.ws-cell.temp-select');
    cells.forEach(c => c.classList.remove('temp-select'));
}

function handleWordSearchCellClick(e) {
    const cell = e.currentTarget;
    const x = parseInt(cell.getAttribute('data-x'));
    const y = parseInt(cell.getAttribute('data-y'));
    const area = document.getElementById('wordSearchArea');
    if (!area) return;

    // First click: start selection
    if (!wsSelectStart) {
        clearTempWsSelection();
        wsSelectStart = { x, y };
        cell.classList.add('temp-select');
        return;
    }

    // Second click: end selection and evaluate
    const start = wsSelectStart;
    wsSelectStart = null;

    const dxRaw = x - start.x;
    const dyRaw = y - start.y;
    const dx = Math.sign(dxRaw);
    const dy = Math.sign(dyRaw);

    // Ignore if same cell
    if (dx === 0 && dy === 0) {
        clearTempWsSelection();
        return;
    }

    const lenX = Math.abs(dxRaw);
    const lenY = Math.abs(dyRaw);
    const straightLine = (dx === 0 || dy === 0) || (lenX === lenY && dx !== 0 && dy !== 0);
    if (!straightLine) {
        clearTempWsSelection();
        return;
    }

    const coords = [];
    let cx = start.x;
    let cy = start.y;
    coords.push({ x: cx, y: cy });
    while (cx !== x || cy !== y) {
        cx += dx;
        cy += dy;
        coords.push({ x: cx, y: cy });
    }

    // Build word in both directions
    let letters = '';
    coords.forEach(c => {
        letters += wordSearchGrid[c.y][c.x];
    });
    const forward = letters.toUpperCase();
    const backward = letters.split('').reverse().join('').toUpperCase();

    let matchedWord = null;
    wordSearchWords.forEach(w => {
        if (w === forward || w === backward) {
            matchedWord = w;
        }
    });

    clearTempWsSelection();

    if (!matchedWord) {
        // No match, nothing to highlight
        return;
    }

    // Highlight matched word cells permanently
    coords.forEach(c => {
        const matchCell = area.querySelector(`.ws-cell[data-x="${c.x}"][data-y="${c.y}"]`);
        if (matchCell) {
            matchCell.classList.add('highlight');
        }
    });

    wordSearchFound.add(matchedWord);
    const li = area.querySelector(`.ws-word-list li[data-ws-word="${matchedWord}"]`);
    if (li) {
        li.style.textDecoration = 'line-through';
    }
}

function completeWordSearch() {
    if (!wordSearchWords.length) return;
    const found = wordSearchFound.size;
    const total = wordSearchWords.length;
    const elapsedSec = wsStartTime ? Math.max(1, Math.round((Date.now() - wsStartTime) / 1000)) : 0;
    stopWsTimer();
    alert(`You found ${found} out of ${total} words in ${elapsedSec} seconds!`);

    fetch('/api/games/wordsearch/score', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ found: found, total: total, seconds: elapsedSec })
    }).catch(err => console.error('Error sending word search score:', err));
}
</script>
{% endblock %}
